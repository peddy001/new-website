<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Life OS | Personal Life Planner</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3498db">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/renderers/CSS2DRenderer.js"></script>

    <style>
        /* All CSS from the previous version goes here... (truncated for brevity) */
        :root{--font-primary:'Poppins',sans-serif;--font-secondary:'Roboto',sans-serif;--bg-light:#f4f7fa;--sidebar-bg-light:#ffffff;--card-bg-light:#ffffff;--text-primary-light:#2c3e50;--text-secondary-light:#7f8c8d;--accent-primary-light:#3498db;--accent-secondary-light:#2ecc71;--border-light:#ecf0f1;--shadow-light:rgba(0,0,0,0.05);--bg-dark:#1c2128;--sidebar-bg-dark:#22272e;--card-bg-dark:#2d333b;--text-primary-dark:#cdd9e5;--text-secondary-dark:#768390;--accent-primary-dark:#58a6ff;--accent-secondary-dark:#56d364;--border-dark:#373e47;--shadow-dark:rgba(0,0,0,0.2)}[data-theme="light"]{--bg:var(--bg-light);--sidebar-bg:var(--sidebar-bg-light);--card-bg:var(--card-bg-light);--text-primary:var(--text-primary-light);--text-secondary:var(--text-secondary-light);--accent-primary:var(--accent-primary-light);--accent-secondary:var(--accent-secondary-light);--border-color:var(--border-light);--shadow-color:var(--shadow-light)}[data-theme="dark"]{--bg:var(--bg-dark);--sidebar-bg:var(--sidebar-bg-dark);--card-bg:var(--card-bg-dark);--text-primary:var(--text-primary-dark);--text-secondary:var(--text-secondary-dark);--accent-primary:var(--accent-primary-dark);--accent-secondary:var(--accent-secondary-dark);--border-color:var(--border-dark);--shadow-color:var(--shadow-dark)}@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Roboto:wght@400;500&display=swap');*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}html,body{height:100%;overflow:hidden;font-family:var(--font-primary);background-color:var(--bg);color:var(--text-primary);transition:background-color .3s,color .3s}.app-container{display:flex;height:100vh}.sidebar{width:260px;background-color:var(--sidebar-bg);border-right:1px solid var(--border-color);display:flex;flex-direction:column;padding:1.5rem 1rem;transition:all .3s;flex-shrink:0}.sidebar-header{display:flex;align-items:center;gap:10px;margin-bottom:2.5rem;padding:0 .5rem}.sidebar-header .logo{font-size:2rem;color:var(--accent-primary)}.sidebar-header h1{font-size:1.25rem;font-weight:600}.nav-menu{list-style:none;flex-grow:1}.nav-item a{display:flex;align-items:center;padding:.8rem 1rem;margin-bottom:.5rem;border-radius:8px;text-decoration:none;color:var(--text-secondary);font-weight:500;transition:background-color .2s,color .2s}.nav-item a:hover{background-color:var(--accent-primary);color:#fff}.nav-item a.active{background-color:var(--accent-primary);color:#fff;font-weight:600}.nav-item a i{width:30px;text-align:center;font-size:1.1rem}.theme-switcher{display:flex;align-items:center;justify-content:space-between;padding:.8rem 1rem;background-color:var(--bg);border-radius:8px;margin-top:1rem}.theme-switcher span{font-weight:500}.switch{position:relative;display:inline-block;width:50px;height:26px}.switch input{opacity:0;width:0;height:0}.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:34px}.slider:before{position:absolute;content:"";height:20px;width:20px;left:3px;bottom:3px;background-color:#fff;transition:.4s;border-radius:50%}input:checked+.slider{background-color:var(--accent-primary)}input:checked+.slider:before{transform:translateX(24px)}.main-content{flex-grow:1;overflow-y:auto;padding:2rem}.page{display:none}.page.active{display:block;animation:fadeIn .5s ease-in-out}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}h2{font-size:1.8rem;margin-bottom:1.5rem;font-weight:600}.card{background-color:var(--card-bg);border-radius:12px;padding:1.5rem;box-shadow:0 4px 15px var(--shadow-color);border:1px solid var(--border-color);transition:transform .2s,box-shadow .2s}.card:hover{transform:translateY(-5px);box-shadow:0 8px 25px var(--shadow-color)}.grid-container{display:grid;gap:1.5rem}.dashboard-grid{grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}.stat-card{display:flex;align-items:center;gap:1.5rem}.stat-card .icon{font-size:2.5rem;padding:1rem;border-radius:50%;display:flex;align-items:center;justify-content:center}.stat-card .icon.savings{background-color:#e8f5e9;color:#4caf50}.stat-card .icon.income{background-color:#e3f2fd;color:#2196f3}.stat-card .icon.expenses{background-color:#ffebee;color:#f44336}.stat-card .icon.discipline{background-color:#fff3e0;color:#ff9800}[data-theme="dark"] .stat-card .icon{background-color:rgba(255,255,255,.1)}.stat-card .info h3{font-size:1rem;color:var(--text-secondary);margin-bottom:.25rem}.stat-card .info p{font-size:1.75rem;font-weight:700}.progress-card h3{margin-bottom:1rem}.progress-bar-container{width:100%;background-color:var(--border-color);border-radius:10px;height:10px;overflow:hidden}.progress-bar{height:100%;background:linear-gradient(90deg,var(--accent-primary),var(--accent-secondary));width:0;border-radius:10px;transition:width .5s ease-in-out}.quote-card{grid-column:1/-1;text-align:center}.quote-card blockquote{font-size:1.2rem;font-style:italic;margin-bottom:.5rem}.quote-card footer{color:var(--text-secondary)}.timeline{position:relative;padding:2rem 0;list-style:none}.timeline::before{content:'';position:absolute;top:0;left:20px;height:100%;width:4px;background:var(--border-color);border-radius:2px}.timeline-item{margin-bottom:2rem;position:relative;padding-left:50px}.timeline-item .icon{position:absolute;left:0;top:0;width:44px;height:44px;border-radius:50%;background-color:var(--sidebar-bg);border:4px solid var(--border-color);display:flex;align-items:center;justify-content:center;font-size:1.2rem;color:var(--text-secondary);z-index:1;margin-left:-2px}.timeline-item.complete .icon{background-color:var(--accent-secondary);border-color:var(--accent-secondary);color:#fff}.timeline-content{background-color:var(--card-bg);padding:1rem 1.5rem;border-radius:8px;border:1px solid var(--border-color)}.timeline-content h4{font-size:1.1rem;font-weight:600}.timeline-content .meta{font-size:.9rem;color:var(--text-secondary);margin:.25rem 0}.timeline-item.complete .timeline-content{opacity:.7;text-decoration:line-through}.form-group{margin-bottom:1rem}.form-group label{display:block;margin-bottom:.5rem;font-weight:500}input[type="text"],input[type="number"],input[type="date"],textarea{width:100%;padding:.75rem;border:1px solid var(--border-color);background-color:var(--bg);border-radius:8px;font-family:var(--font-primary);color:var(--text-primary);font-size:1rem;transition:border-color .2s,box-shadow .2s}input:focus,textarea:focus{outline:0;border-color:var(--accent-primary);box-shadow:0 0 0 3px rgba(52,152,219,.2)}.btn{padding:.75rem 1.5rem;border:none;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;transition:all .2s}.btn-primary{background-color:var(--accent-primary);color:#fff}.btn-primary:hover{opacity:.9}.btn-secondary{background-color:var(--accent-secondary);color:#fff}.land-plot{width:100%;aspect-ratio:2/1;border:3px solid var(--accent-primary);background-color:var(--bg);display:flex;flex-direction:column;position:relative}.zone{display:flex;align-items:center;justify-content:center;font-weight:600;font-size:1.2rem;color:#fff;text-shadow:1px 1px 3px rgba(0,0,0,.5);position:relative;overflow:hidden}.zone-business{flex:1;background-color:#e74c3c}.zone-home{flex:2;background-color:#3498db}.zone-farm{flex:4;background-color:#27ae60;display:flex}.zone-farm-crops{flex:1;background-color:#2ecc71}.zone-farm-livestock{flex:1;background-color:#f39c12}.tooltip{visibility:hidden;width:180px;background-color:var(--card-bg-dark);color:#fff;text-align:center;border-radius:6px;padding:5px 0;position:absolute;z-index:1;bottom:125%;left:50%;margin-left:-90px;opacity:0;transition:opacity .3s}.tooltip::after{content:"";position:absolute;top:100%;left:50%;margin-left:-5px;border-width:5px;border-style:solid;border-color:var(--card-bg-dark) transparent transparent transparent}.zone:hover .tooltip{visibility:visible;opacity:1}#three-container{width:100%;height:500px;border-radius:12px;position:relative;background-color:var(--bg);border:1px solid var(--border-color);overflow:hidden;display:flex;align-items:center;justify-content:center}.label{color:var(--text-primary);font-family:var(--font-primary);padding:2px 8px;background:rgba(255,255,255,.7);border-radius:4px;border:1px solid var(--border-color)}[data-theme="dark"] .label{background:rgba(0,0,0,.7)}.habit-list{list-style:none}.habit-item{display:flex;align-items:center;justify-content:space-between;padding:1rem;background-color:var(--bg);border-radius:8px;margin-bottom:.5rem;border:1px solid var(--border-color)}.habit-item label{font-size:1.1rem;display:flex;align-items:center;gap:1rem;cursor:pointer}.habit-item .streak{font-size:.9rem;color:var(--text-secondary);background:var(--border-color);padding:2px 8px;border-radius:10px}#calendar{height:600px}.fc{--fc-border-color:var(--border-color);--fc-today-bg-color:rgba(52,152,219,.1);--fc-button-bg-color:var(--accent-primary);--fc-button-border-color:var(--accent-primary);--fc-button-hover-bg-color:#2980b9;--fc-button-hover-border-color:#2980b9}.fc .fc-toolbar-title{color:var(--text-primary);font-size:1.5em}.fc .fc-daygrid-day-number{color:var(--text-secondary)}.fc-event{cursor:pointer}[data-theme="dark"] .fc{--fc-today-bg-color:rgba(88,166,255,.15)}[data-theme="dark"] .fc .fc-daygrid-day-frame{background-color:var(--card-bg)}[data-theme="dark"] .fc-non-business-day{background-color:var(--bg)}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.5);align-items:center;justify-content:center}.modal-content{background-color:var(--card-bg);margin:auto;padding:2rem;border:1px solid var(--border-color);width:90%;max-width:500px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);text-align:center;animation:modal-pop .3s cubic-bezier(.18,.89,.32,1.28)}@keyframes modal-pop{from{transform:scale(.7);opacity:0}to{transform:scale(1);opacity:1}}.modal-icon{font-size:4rem;color:var(--accent-secondary);margin-bottom:1rem}.close-button{color:#aaa;float:right;font-size:28px;font-weight:bold;position:absolute;top:10px;right:20px}.close-button:hover,.close-button:focus{color:var(--text-primary);text-decoration:none;cursor:pointer}@media (max-width:768px){.app-container{flex-direction:column}.sidebar{width:100%;height:auto;flex-direction:row;align-items:center;padding:.5rem 1rem;overflow-x:auto;border-right:none;border-bottom:1px solid var(--border-color)}.sidebar-header{margin-bottom:0}.nav-menu{display:flex;flex-direction:row}.nav-item a{padding:.5rem;margin-bottom:0;margin-right:.5rem}.nav-item a span{display:none}.theme-switcher{margin-top:0;margin-left:auto;padding:.5rem}.theme-switcher span{display:none}.main-content{padding:1rem}h2{font-size:1.5rem}}
    </style>
</head>
<body>

    <div class="app-container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-rocket logo"></i>
                <h1>Life OS</h1>
            </div>
            <ul class="nav-menu">
                <li class="nav-item"><a href="#overview" class="nav-link active"><i class="fas fa-tachometer-alt"></i> <span>Overview</span></a></li>
                <li class="nav-item"><a href="#timeline" class="nav-link"><i class="fas fa-timeline"></i> <span>Life Goals</span></a></li>
                <li class="nav-item"><a href="#finance" class="nav-link"><i class="fas fa-coins"></i> <span>Finances</span></a></li>
                <li class="nav-item"><a href="#land" class="nav-link"><i class="fas fa-map-marked-alt"></i> <span>Land Plan</span></a></li>
                <li class="nav-item"><a href="#discipline" class="nav-link"><i class="fas fa-fist-raised"></i> <span>Discipline</span></a></li>
                <li class="nav-item"><a href="#spiritual" class="nav-link"><i class="fas fa-pray"></i> <span>Anchor</span></a></li>
                <li class="nav-item"><a href="#calendar" class="nav-link"><i class="fas fa-calendar-alt"></i> <span>Calendar</span></a></li>
                <li class="nav-item"><a href="#settings" class="nav-link"><i class="fas fa-cog"></i> <span>Settings</span></a></li>
            </ul>
            <div class="theme-switcher">
                <span>Dark Mode</span>
                <label class="switch">
                    <input type="checkbox" id="theme-toggle">
                    <span class="slider"></span>
                </label>
            </div>
        </nav>

        <main class="main-content">
            <section id="overview" class="page active">
                <h2>Overview Dashboard</h2>
                <div class="grid-container dashboard-grid">
                    <div class="card stat-card">
                        <div class="icon savings"><i class="fas fa-piggy-bank"></i></div>
                        <div class="info">
                            <h3>Total Savings</h3>
                            <p id="total-savings-display">KSH 0</p>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="icon income"><i class="fas fa-arrow-down"></i></div>
                        <div class="info">
                            <h3>Monthly Income</h3>
                            <p id="monthly-income-display">KSH 0</p>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="icon expenses"><i class="fas fa-arrow-up"></i></div>
                        <div class="info">
                            <h3>Monthly Expenses</h3>
                            <p id="monthly-expenses-display">KSH 0</p>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="icon discipline"><i class="fas fa-award"></i></div>
                        <div class="info">
                            <h3>Discipline Score</h3>
                            <p id="discipline-score-display">0%</p>
                        </div>
                    </div>
                    <div class="card progress-card" style="grid-column: span 2;">
                        <h3>Overall Timeline Progress</h3>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="timeline-progress-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div class="card quote-card">
                        <blockquote id="quote-text">Loading quote...</blockquote>
                        <footer id="quote-author"></footer>
                    </div>
                </div>
            </section>

            <section id="timeline" class="page">
                <h2>Timeline & Life Goals</h2>
                <div class="card">
                    <ul class="timeline" id="timeline-list">
                    </ul>
                    <hr style="margin: 2rem 0; border: 1px solid var(--border-color);">
                    <h3>Add a New Goal</h3>
                    <div class="form-group">
                        <label for="new-goal-text">Goal Description</label>
                        <input type="text" id="new-goal-text" placeholder="e.g., Learn a new skill">
                    </div>
                    <div class="form-group">
                        <label for="new-goal-date">Target Date</label>
                        <input type="date" id="new-goal-date">
                    </div>
                    <button id="add-goal-btn" class="btn btn-primary"><i class="fas fa-plus"></i> Add Goal</button>
                </div>
            </section>

            <section id="finance" class="page">
                <h2>Financial Planner</h2>
                <div class="grid-container" style="grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="card">
                        <h3>Monthly Budget Calculator</h3>
                        <div class="form-group">
                            <label for="income-input">Total Monthly Income (KSH)</label>
                            <input type="number" id="income-input" placeholder="e.g., 50000">
                        </div>
                        <div class="form-group">
                            <label for="expenses-input">Total Monthly Expenses (KSH)</label>
                            <input type="number" id="expenses-input" placeholder="e.g., 30000">
                        </div>
                        <h4>Potential Monthly Savings: <span id="monthly-savings-result" style="color: var(--accent-secondary); font-weight: 700;">KSH 0</span></h4>
                    </div>
                    <div class="card">
                        <h3>Update Cumulative Savings</h3>
                        <div class="form-group">
                            <label for="savings-update-input">Amount Saved This Month (KSH)</label>
                            <input type="number" id="savings-update-input" placeholder="Enter amount to add to total">
                        </div>
                        <button id="update-savings-btn" class="btn btn-secondary"><i class="fas fa-plus-circle"></i> Add to Savings</button>
                    </div>
                    <div class="card" style="grid-column: 1 / -1;">
                        <h3>Savings Growth</h3>
                        <canvas id="savings-chart"></canvas>
                    </div>
                    <div class="card">
                        <h3>Budget Allocation Guide (70/20/10)</h3>
                        <ul>
                            <li><strong>70% Needs:</strong> <span id="budget-needs">KSH 0</span></li>
                            <li><strong>20% Project Savings:</strong> <span id="budget-savings">KSH 0</span></li>
                            <li><strong>10% Flex/Wants:</strong> <span id="budget-wants">KSH 0</span></li>
                        </ul>
                    </div>
                    <div class="card">
                        <h3>Phased Project Costs (Estimates)</h3>
                        <ul>
                            <li><strong>Home (2-Bedroom):</strong> ~KSH 1,500,000</li>
                            <li><strong>Farm Setup:</strong> ~KSH 500,000</li>
                            <li><strong>Business Startup:</strong> ~KSH 800,000</li>
                        </ul>
                    </div>
                </div>
            </section>
            
            <section id="land" class="page">
                <h2>Land Zoning Plan (1 Acre)</h2>
                <div class="grid-container" style="grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="card">
                        <h3>2D Blueprint</h3>
                        <div class="land-plot">
                            <div class="zone zone-business">Business Zone<span class="tooltip">Shop, Agrovet, Posho Mill, Milk Shop</span></div>
                            <div class="zone zone-home">Home Zone<span class="tooltip">Main 2-bedroom house and garden</span></div>
                            <div class="zone zone-farm">
                                <div class="zone zone-farm-crops">Crops<span class="tooltip">50% of farm area for various crops</span></div>
                                <div class="zone zone-farm-livestock">Livestock<span class="tooltip">50% of farm area for animals</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <h3>3D Visualization</h3>
                        <div id="three-container"></div>
                        <p style="text-align: center; margin-top: 1rem; color: var(--text-secondary);">Click and drag to rotate. Scroll to zoom.</p>
                        <p style="font-size: 0.8rem; text-align: center; margin-top: 0.5rem;">Note: This is a basic representation.</p>
                    </div>
                </div>
            </section>

            <section id="discipline" class="page">
                <h2>Discipline & Routine Tracker</h2>
                 <div class="grid-container" style="grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="card"><h3>Daily Habits</h3><ul class="habit-list" id="daily-habits-list"></ul></div>
                    <div class="card"><h3>Weekly Routine</h3><ul class="habit-list" id="weekly-habits-list"></ul></div>
                </div>
            </section>

            <section id="spiritual" class="page">
                <h2>Spiritual & Motivational Anchor</h2>
                <div class="grid-container" style="grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="card"><h3>Verse of the Day</h3><div id="daily-verse-container" style="min-height: 100px;"><blockquote id="verse-text"></blockquote><footer id="verse-ref"></footer></div></div>
                    <div class="card"><h3>Weekly Affirmation</h3><div class="form-group"><textarea id="affirmation-input" rows="4" placeholder="Write your affirmation for the week..."></textarea></div><button id="save-affirmation-btn" class="btn btn-primary">Save Affirmation</button></div>
                    <div class="card" style="grid-column: 1 / -1;"><h3>Daily Journal & Reflection</h3><div class="form-group"><label for="journal-entry">What did I learn or feel today?</label><textarea id="journal-entry" rows="8" placeholder="Reflect on your day..."></textarea></div></div>
                </div>
            </section>

            <section id="calendar" class="page">
                <h2>Calendar & Reminders</h2><div class="card"><div id="calendar"></div></div>
            </section>

            <section id="settings" class="page">
                <h2>Settings & Data Management</h2>
                <div class="card">
                    <h3>Performance</h3>
                    <div class="theme-switcher" style="padding: 0; background: none;">
                        <span>Enable Lite Mode (disables 3D)</span>
                        <label class="switch">
                            <input type="checkbox" id="lite-mode-toggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.5rem;">Recommended for older devices. Refresh the page for changes to take effect.</p>
                    <hr style="margin: 2rem 0; border: 1px solid var(--border-color);">
                    <h3>Data Backup</h3>
                    <p>Export your data as a JSON file for backup, or import a previous backup.</p>
                    <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                        <button id="export-data-btn" class="btn btn-primary"><i class="fas fa-file-export"></i> Export</button>
                        <button onclick="document.getElementById('import-file-input').click();" class="btn btn-secondary"><i class="fas fa-file-import"></i> Import</button>
                        <input type="file" id="import-file-input" accept=".json" style="display: none;">
                    </div>
                    <hr style="margin: 2rem 0; border: 1px solid var(--border-color);">
                    <h3>Reset Application</h3>
                    <p style="color: #e74c3c;">Warning: This will permanently delete all your data.</p>
                    <div style="margin-top: 1rem;">
                        <button id="reset-data-btn" class="btn" style="background-color: #e74c3c; color: white;"><i class="fas fa-exclamation-triangle"></i> Reset All Data</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="milestone-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="modal-close-btn">&times;</span>
            <div class="modal-icon"><i class="fas fa-trophy"></i></div>
            <h2>Milestone Achieved!</h2>
            <p id="modal-message"></p>
        </div>
    </div>

    <script>
        // ** CORRECTED JAVASCRIPT - Un-minified and readable **
        document.addEventListener('DOMContentLoaded', () => {

            // --- GLOBAL VARIABLES & CONSTANTS ---
            const KSH_FORMATTER = new Intl.NumberFormat('en-KE', { style: 'currency', currency: 'KSH', minimumFractionDigits: 0 });
            const DAILY_QUOTES = [
                { text: "The secret of getting ahead is getting started.", author: "Mark Twain" },
                { text: "The journey of a thousand miles begins with a single step.", author: "Lao Tzu" },
                { text: "Commit your works to the LORD, and your thoughts will be established.", author: "Proverbs 16:3" },
                { text: "Believe you can and you're halfway there.", author: "Theodore Roosevelt" },
                { text: "The best time to plant a tree was 20 years ago. The second best time is now.", author: "Chinese Proverb" }
            ];
            const DAILY_VERSES = [
                { text: "For I know the plans I have for you, declares the LORD, plans for welfare and not for evil, to give you a future and a hope.", ref: "Jeremiah 29:11" },
                { text: "Trust in the LORD with all your heart, and do not lean on your own understanding.", ref: "Proverbs 3:5" },
                { text: "I can do all things through him who strengthens me.", ref: "Philippians 4:13" },
                { text: "The steadfast love of the LORD never ceases; his mercies never come to an end; they are new every morning; great is your faithfulness.", ref: "Lamentations 3:22-23" }
            ];

            // --- STATE MANAGEMENT ---
            let appData = {};
            let savingsChart;
            let calendar;
            let threeScene, threeCamera, threeRenderer, threeControls, threeLabelRenderer;

            const defaultData = {
                settings: {
                    theme: 'light',
                    liteMode: false
                },
                startDate: '2025-08-22',
                startAge: 24,
                finances: {
                    totalSavings: 0,
                    income: 0,
                    expenses: 0,
                    history: [] // { month: 'YYYY-MM', amount: 10000 }
                },
                goals: [
                    { id: 1, text: 'Finish ICT Diploma', date: '2026-04-30', complete: false },
                    { id: 2, text: 'Job Hunt + Savings Phase', date: '2027-12-31', complete: false },
                    { id: 3, text: 'Build 2-Bedroom House', date: '2028-12-31', complete: false },
                    { id: 4, text: 'Farm Setup (Crops & Livestock)', date: '2029-12-31', complete: false },
                    { id: 5, text: 'Expand Business (Shop, Agrovet, etc.)', date: '2030-12-31', complete: false }
                ],
                habits: {
                    'wake-early': { lastChecked: null, streak: 0 },
                    'prayer-meditation': { lastChecked: null, streak: 0 },
                    'exercise': { lastChecked: null, streak: 0 },
                    'ict-learning': { lastChecked: null, streak: 0 },
                    'journal-review': { lastChecked: null, streak: 0 },
                    'track-spending': { lastChecked: null },
                    'review-goals': { lastChecked: null },
                    'savings-update': { lastChecked: null }
                },
                journal: {}, // { 'YYYY-MM-DD': 'entry' }
                affirmation: ""
            };

            const dailyHabitsConfig = [
                { id: 'wake-early', name: 'Wake Early' },
                { id: 'prayer-meditation', name: 'Prayer / Meditation' },
                { id: 'exercise', name: 'Exercise' },
                { id: 'ict-learning', name: 'ICT Learning / Practice' },
                { id: 'journal-review', name: 'Journal & Review' }
            ];

            const weeklyHabitsConfig = [
                { id: 'track-spending', name: 'Track Spending' },
                { id: 'review-goals', name: 'Review Goals' },
                { id: 'savings-update', name: 'Savings Update' }
            ];

            function saveData() {
                localStorage.setItem('lifeOSData', JSON.stringify(appData));
            }

            function loadData() {
                const data = localStorage.getItem('lifeOSData');
                appData = data ? JSON.parse(data) : JSON.parse(JSON.stringify(defaultData));
                appData.settings = { ...defaultData.settings, ...appData.settings };
                appData.goals = appData.goals || defaultData.goals;
                appData.habits = { ...defaultData.habits, ...appData.habits };
            }

            // --- INITIALIZATION ---
            function init() {
                loadData();
                initTheme();
                initNavigation();
                initDashboard();
                initTimeline();
                initFinance();
                initDiscipline();
                initSpiritual();
                initCalendar();
                if (!appData.settings.liteMode) {
                    init3D();
                } else {
                    document.getElementById('three-container').innerHTML = 
                        `<p style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                            <i class="fas fa-leaf" style="font-size: 2rem; margin-bottom: 1rem;"></i><br>
                            3D Visualization is disabled in Lite Mode to improve performance.
                        </p>`;
                }
                initSettings();
            }

            // --- THEME & NAVIGATION ---
            function initTheme() {
                const themeToggle = document.getElementById('theme-toggle');
                if (appData.settings.theme === 'dark') {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    themeToggle.checked = true;
                } else {
                    document.documentElement.setAttribute('data-theme', 'light');
                    themeToggle.checked = false;
                }
                themeToggle.addEventListener('change', () => {
                    if (themeToggle.checked) {
                        appData.settings.theme = 'dark';
                        document.documentElement.setAttribute('data-theme', 'dark');
                    } else {
                        appData.settings.theme = 'light';
                        document.documentElement.setAttribute('data-theme', 'light');
                    }
                    updateChartTheme();
                    saveData();
                });
            }
            
            function initNavigation() {
                const navLinks = document.querySelectorAll('.nav-link');
                const pages = document.querySelectorAll('.page');
                navLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const targetId = link.getAttribute('href').substring(1);

                        navLinks.forEach(l => l.classList.remove('active'));
                        link.classList.add('active');

                        pages.forEach(page => {
                            page.classList.toggle('active', page.id === targetId);
                        });
                        
                        if(targetId === 'calendar' && calendar) calendar.render();
                        if(targetId === 'land' && threeRenderer) onWindowResize();
                    });
                });
            }

            // --- DASHBOARD ---
            function initDashboard() {
                updateDashboard();
                const today = new Date().getDate();
                const quote = DAILY_QUOTES[today % DAILY_QUOTES.length];
                document.getElementById('quote-text').textContent = `"${quote.text}"`;
                document.getElementById('quote-author').textContent = `— ${quote.author}`;
            }

            function updateDashboard() {
                animateCounter('total-savings-display', appData.finances.totalSavings, true);
                animateCounter('monthly-income-display', appData.finances.income, true);
                animateCounter('monthly-expenses-display', appData.finances.expenses, true);
                
                const disciplineScore = calculateDisciplineScore();
                document.getElementById('discipline-score-display').textContent = `${disciplineScore.toFixed(0)}%`;
                
                const completedGoals = appData.goals.filter(g => g.complete).length;
                const totalGoals = appData.goals.length;
                const progress = totalGoals > 0 ? (completedGoals / totalGoals) * 100 : 0;
                document.getElementById('timeline-progress-bar').style.width = `${progress}%`;
            }
            
            function animateCounter(id, endValue, isCurrency = false) {
                const element = document.getElementById(id);
                const startValue = parseFloat(element.textContent.replace(/[^\d.-]/g, '')) || 0;
                const duration = 1000;
                let startTime = null;

                function animation(currentTime) {
                    if (startTime === null) startTime = currentTime;
                    const progress = Math.min((currentTime - startTime) / duration, 1);
                    const currentValue = startValue + (endValue - startValue) * progress;
                    element.textContent = isCurrency ? KSH_FORMATTER.format(currentValue) : currentValue.toFixed(0);
                    if (progress < 1) {
                        requestAnimationFrame(animation);
                    }
                }
                requestAnimationFrame(animation);
            }

            // --- TIMELINE & GOALS ---
            function initTimeline() {
                renderTimeline();
                document.getElementById('add-goal-btn').addEventListener('click', addGoal);
            }

            function renderTimeline() {
                const timelineList = document.getElementById('timeline-list');
                timelineList.innerHTML = '';
                appData.goals.sort((a,b) => new Date(a.date) - new Date(b.date));

                appData.goals.forEach(goal => {
                    const ageAtGoal = calculateAge(goal.date);
                    const item = document.createElement('li');
                    item.className = `timeline-item ${goal.complete ? 'complete' : ''}`;
                    item.innerHTML = `
                        <div class="icon"><i class="fas ${goal.complete ? 'fa-check' : 'fa-flag-checkered'}"></i></div>
                        <div class="timeline-content">
                            <h4>${goal.text}</h4>
                            <div class="meta">
                                <span>Target: ${new Date(goal.date).toLocaleDateString()}</span> | 
                                <span>Age: ${ageAtGoal}</span>
                            </div>
                            <button class="btn-toggle-complete" data-id="${goal.id}">${goal.complete ? 'Mark as Incomplete' : 'Mark as Complete'}</button>
                        </div>
                    `;
                    timelineList.appendChild(item);
                });

                document.querySelectorAll('.btn-toggle-complete').forEach(button => {
                    button.addEventListener('click', (e) => {
                        toggleGoalComplete(parseInt(e.target.dataset.id));
                    });
                });
            }
            
            function addGoal() {
                const textInput = document.getElementById('new-goal-text');
                const dateInput = document.getElementById('new-goal-date');
                
                if (textInput.value.trim() === '' || dateInput.value === '') {
                    alert('Please provide both a goal description and a target date.');
                    return;
                }

                const newGoal = {
                    id: Date.now(),
                    text: textInput.value.trim(),
                    date: dateInput.value,
                    complete: false
                };
                appData.goals.push(newGoal);
                saveData();
                renderTimeline();
                updateCalendarEvents();
                textInput.value = '';
                dateInput.value = '';
            }

            function toggleGoalComplete(id) {
                const goal = appData.goals.find(g => g.id === id);
                if (goal) {
                    goal.complete = !goal.complete;
                    if(goal.complete) {
                        showMilestoneModal(`"${goal.text}"`);
                    }
                    saveData();
                    renderTimeline();
                    updateDashboard();
                    updateCalendarEvents();
                }
            }
            
            function calculateAge(dateString) {
                const birthDate = new Date(appData.startDate);
                birthDate.setFullYear(birthDate.getFullYear() - appData.startAge);
                const targetDate = new Date(dateString);
                let age = targetDate.getFullYear() - birthDate.getFullYear();
                const m = targetDate.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && targetDate.getDate() < birthDate.getDate())) {
                    age--;
                }
                return age;
            }

            // --- FINANCIAL PLANNER ---
            function initFinance() {
                const incomeInput = document.getElementById('income-input');
                const expensesInput = document.getElementById('expenses-input');
                
                incomeInput.value = appData.finances.income || '';
                expensesInput.value = appData.finances.expenses || '';

                incomeInput.addEventListener('input', updateFinancialCalculations);
                expensesInput.addEventListener('input', updateFinancialCalculations);
                document.getElementById('update-savings-btn').addEventListener('click', updateCumulativeSavings);

                initSavingsChart();
                updateFinancialCalculations();
            }

            function updateFinancialCalculations() {
                const income = parseFloat(document.getElementById('income-input').value) || 0;
                const expenses = parseFloat(document.getElementById('expenses-input').value) || 0;
                
                appData.finances.income = income;
                appData.finances.expenses = expenses;

                const potentialSavings = income - expenses;
                document.getElementById('monthly-savings-result').textContent = KSH_FORMATTER.format(potentialSavings > 0 ? potentialSavings : 0);
                
                document.getElementById('budget-needs').textContent = KSH_FORMATTER.format(income * 0.7);
                document.getElementById('budget-savings').textContent = KSH_FORMATTER.format(income * 0.2);
                document.getElementById('budget-wants').textContent = KSH_FORMATTER.format(income * 0.1);

                updateDashboard();
                saveData();
            }
            
            function updateCumulativeSavings() {
                const savingsInput = document.getElementById('savings-update-input');
                const amount = parseFloat(savingsInput.value);

                if (isNaN(amount) || amount <= 0) {
                    alert('Please enter a valid, positive amount.');
                    return;
                }

                appData.finances.totalSavings += amount;
                
                const today = new Date();
                const monthKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                const monthRecord = appData.finances.history.find(h => h.month === monthKey);
                if(monthRecord) {
                    monthRecord.amount += amount;
                } else {
                    appData.finances.history.push({ month: monthKey, amount: amount });
                }
                
                saveData();
                updateDashboard();
                updateSavingsChart();
                savingsInput.value = '';
            }

            function initSavingsChart() {
                const ctx = document.getElementById('savings-chart').getContext('2d');
                savingsChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [{ label: 'Monthly Savings (KSH)', data: [], tension: 0.4, fill: true }] },
                    options: { responsive: true, scales: {}, plugins: {} }
                });
                updateSavingsChart();
            }

            function updateSavingsChart() {
                appData.finances.history.sort((a,b) => a.month.localeCompare(b.month));
                savingsChart.data.labels = appData.finances.history.map(h => h.month);
                savingsChart.data.datasets[0].data = appData.finances.history.map(h => h.amount);
                updateChartTheme();
                savingsChart.update();
            }
            
            function updateChartTheme() {
                if (!savingsChart) return;
                const theme = appData.settings.theme || 'light';
                const gridColor = theme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                const textColor = theme === 'dark' ? '#cdd9e5' : '#2c3e50';
                const accentPrimary = theme === 'dark' ? 'rgba(88, 166, 255, 1)' : 'rgba(52, 152, 219, 1)';
                const accentPrimaryBg = theme === 'dark' ? 'rgba(88, 166, 255, 0.2)' : 'rgba(52, 152, 219, 0.2)';

                savingsChart.options.scales = {
                    y: { ticks: { color: textColor }, grid: { color: gridColor } },
                    x: { ticks: { color: textColor }, grid: { color: gridColor } }
                };
                savingsChart.options.plugins = { legend: { labels: { color: textColor } } };
                
                savingsChart.data.datasets[0].borderColor = accentPrimary;
                savingsChart.data.datasets[0].backgroundColor = accentPrimaryBg;
                
                savingsChart.update();
            }

            // --- 3D VISUALIZATION ---
            function init3D() {
                const container = document.getElementById('three-container');
                if (!container) return;
                container.innerHTML = '';

                threeScene = new THREE.Scene();
                threeScene.background = new THREE.Color(appData.settings.theme === 'dark' ? 0x1c2128 : 0xf4f7fa);
                
                threeCamera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
                threeCamera.position.set(10, 15, 20);

                threeRenderer = new THREE.WebGLRenderer({ antialias: true });
                threeRenderer.setSize(container.clientWidth, container.clientHeight);
                container.appendChild(threeRenderer.domElement);
                
                threeLabelRenderer = new THREE.CSS2DRenderer();
                threeLabelRenderer.setSize(container.clientWidth, container.clientHeight);
                threeLabelRenderer.domElement.style.position = 'absolute';
                threeLabelRenderer.domElement.style.top = '0px';
                container.appendChild(threeLabelRenderer.domElement);

                threeControls = new THREE.OrbitControls(threeCamera, threeLabelRenderer.domElement);
                threeControls.enableDamping = true;

                const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
                threeScene.add(ambientLight);
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(5, 10, 7.5);
                threeScene.add(directionalLight);

                const plot = new THREE.Mesh(new THREE.PlaneGeometry(30, 15), new THREE.MeshStandardMaterial({ color: 0x5a8a3a }));
                plot.rotation.x = -Math.PI / 2;
                threeScene.add(plot);

                function createZone(x, z, width, depth, color, name) {
                    const zoneGeo = new THREE.BoxGeometry(width, 2, depth);
                    const zoneMat = new THREE.MeshStandardMaterial({ color: color, transparent: true, opacity: 0.8 });
                    const zone = new THREE.Mesh(zoneGeo, zoneMat);
                    zone.position.set(x, 1, z);
                    threeScene.add(zone);

                    const labelDiv = document.createElement('div');
                    labelDiv.className = 'label';
                    labelDiv.textContent = name;
                    const label = new THREE.CSS2DObject(labelDiv);
                    label.position.set(0, 2, 0);
                    zone.add(label);
                }
                
                createZone(0, -6, 30, 3, 0xe74c3c, 'Business Zone');
                createZone(0, -1.5, 10, 6, 0x3498db, 'Home Zone');
                createZone(-7.5, 4.5, 15, 6, 0x2ecc71, 'Crops');
                createZone(7.5, 4.5, 15, 6, 0xf39c12, 'Livestock');

                function animate() {
                    requestAnimationFrame(animate);
                    threeControls.update();
                    threeRenderer.render(threeScene, threeCamera);
                    threeLabelRenderer.render(threeScene, threeCamera);
                }
                animate();
                
                window.addEventListener('resize', onWindowResize, false);
            }
            
            function onWindowResize() {
                const container = document.getElementById('three-container');
                if (!container || !threeCamera || !threeRenderer) return;
                threeCamera.aspect = container.clientWidth / container.clientHeight;
                threeCamera.updateProjectionMatrix();
                threeRenderer.setSize(container.clientWidth, container.clientHeight);
                threeLabelRenderer.setSize(container.clientWidth, container.clientHeight);
            }

            // --- DISCIPLINE TRACKER ---
            function initDiscipline() {
                renderHabits();
            }

            function renderHabits() {
                const dailyList = document.getElementById('daily-habits-list');
                const weeklyList = document.getElementById('weekly-habits-list');
                dailyList.innerHTML = '';
                weeklyList.innerHTML = '';
                const todayStr = new Date().toISOString().split('T')[0];

                dailyHabitsConfig.forEach(habit => {
                    const habitData = appData.habits[habit.id];
                    const isChecked = habitData.lastChecked === todayStr;
                    const li = document.createElement('li');
                    li.className = 'habit-item';
                    li.innerHTML = `
                        <label>
                            <input type="checkbox" data-habit-id="${habit.id}" data-type="daily" ${isChecked ? 'checked' : ''}>
                            <span>${habit.name}</span>
                        </label>
                        <span class="streak">${habitData.streak || 0} day streak 🔥</span>`;
                    dailyList.appendChild(li);
                });
                
                const weekNumber = getWeekNumber(new Date());
                weeklyHabitsConfig.forEach(habit => {
                    const habitData = appData.habits[habit.id];
                    const isChecked = habitData.lastChecked === weekNumber.toString();
                    const li = document.createElement('li');
                    li.className = 'habit-item';
                    li.innerHTML = `
                        <label>
                            <input type="checkbox" data-habit-id="${habit.id}" data-type="weekly" ${isChecked ? 'checked' : ''}>
                            <span>${habit.name}</span>
                        </label>`;
                    weeklyList.appendChild(li);
                });
                
                document.querySelectorAll('#discipline input[type="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener('change', handleHabitToggle);
                });
            }
            
            function handleHabitToggle(e) {
                const id = e.target.dataset.habitId;
                const type = e.target.dataset.type;
                const habitData = appData.habits[id];
                
                if(type === 'daily') {
                    const today = new Date();
                    const todayStr = today.toISOString().split('T')[0];
                    const yesterday = new Date(today);
                    yesterday.setDate(today.getDate() - 1);
                    const yesterdayStr = yesterday.toISOString().split('T')[0];
                    
                    if(e.target.checked) {
                        habitData.lastChecked = todayStr;
                        if(habitData.lastChecked === yesterdayStr) {
                            habitData.streak++;
                        } else {
                            habitData.streak = 1;
                        }
                    } else {
                        habitData.lastChecked = null;
                        habitData.streak = 0;
                    }
                } else { // Weekly
                    const weekNum = getWeekNumber(new Date()).toString();
                    habitData.lastChecked = e.target.checked ? weekNum : null;
                }
                
                saveData();
                renderHabits();
                updateDashboard();
            }

            function calculateDisciplineScore() {
                const todayStr = new Date().toISOString().split('T')[0];
                const weekNum = getWeekNumber(new Date()).toString();
                let completed = 0;
                
                dailyHabitsConfig.forEach(h => {
                    if (appData.habits[h.id].lastChecked === todayStr) completed++;
                });
                weeklyHabitsConfig.forEach(h => {
                     if (appData.habits[h.id].lastChecked === weekNum) completed++;
                });
                
                const totalHabits = dailyHabitsConfig.length + weeklyHabitsConfig.length;
                return totalHabits > 0 ? (completed / totalHabits) * 100 : 0;
            }
            
            function getWeekNumber(d) {
                d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
                var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
                return Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
            }

            // --- SPIRITUAL ANCHOR ---
            function initSpiritual() {
                const today = new Date().getDate();
                const verse = DAILY_VERSES[today % DAILY_VERSES.length];
                document.getElementById('verse-text').textContent = `"${verse.text}"`;
                document.getElementById('verse-ref').textContent = verse.ref;
                
                const journalEntry = document.getElementById('journal-entry');
                const todayStr = new Date().toISOString().split('T')[0];
                journalEntry.value = appData.journal[todayStr] || '';
                journalEntry.addEventListener('input', () => {
                    appData.journal[todayStr] = journalEntry.value;
                    saveData();
                });

                const affirmationInput = document.getElementById('affirmation-input');
                affirmationInput.value = appData.affirmation || '';
                document.getElementById('save-affirmation-btn').addEventListener('click', () => {
                    appData.affirmation = affirmationInput.value;
                    saveData();
                    alert('Affirmation saved!');
                });
            }
            
            // --- CALENDAR ---
            function initCalendar() {
                const calendarEl = document.getElementById('calendar');
                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,listWeek'
                    },
                    events: [],
                    editable: true,
                    selectable: true,
                    select: handleDateSelect,
                    eventClick: handleEventClick,
                    eventDrop: handleEventChange,
                    eventResize: handleEventChange
                });
                updateCalendarEvents();
            }

            function updateCalendarEvents() {
                if (!calendar) return;
                const events = appData.goals.map(goal => ({
                    id: goal.id,
                    title: goal.text,
                    start: goal.date,
                    allDay: true,
                    backgroundColor: goal.complete ? '#2ecc71' : '#3498db',
                    borderColor: goal.complete ? '#27ae60' : '#2980b9'
                }));
                calendar.removeAllEvents();
                calendar.addEventSource(events);
            }

            function handleDateSelect(selectInfo) {
                let title = prompt('Enter a title for your new event:');
                if (title) {
                    const newGoal = {
                        id: Date.now(),
                        text: title,
                        date: selectInfo.startStr,
                        complete: false
                    };
                    appData.goals.push(newGoal);
                    saveData();
                    renderTimeline();
                    updateCalendarEvents();
                }
                calendar.unselect();
            }

            function handleEventClick(clickInfo) {
                if (confirm(`Do you want to delete the event '${clickInfo.event.title}'?`)) {
                    appData.goals = appData.goals.filter(goal => goal.id != clickInfo.event.id);
                    saveData();
                    renderTimeline();
                    updateCalendarEvents();
                }
            }
            
            function handleEventChange(changeInfo) {
                const goal = appData.goals.find(g => g.id == changeInfo.event.id);
                if(goal){
                    goal.date = changeInfo.event.start.toISOString().split('T')[0];
                    saveData();
                    renderTimeline();
                }
            }

            // --- SETTINGS ---
            function initSettings() {
                const liteModeToggle = document.getElementById('lite-mode-toggle');
                liteModeToggle.checked = appData.settings.liteMode;
                liteModeToggle.addEventListener('change', () => {
                    appData.settings.liteMode = liteModeToggle.checked;
                    saveData();
                    alert('Setting saved. Please refresh the page for the change to take effect.');
                });

                document.getElementById('export-data-btn').addEventListener('click', exportData);
                document.getElementById('import-file-input').addEventListener('change', importData);
                document.getElementById('reset-data-btn').addEventListener('click', resetData);
            }
            
            function exportData() {
                const dataStr = JSON.stringify(appData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `LifeOS_Backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            function importData(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (confirm('Are you sure you want to overwrite all current data with the imported file?')) {
                            appData = importedData;
                            saveData();
                            location.reload();
                        }
                    } catch (error) {
                        alert('Error parsing JSON file. Please ensure it is a valid backup.');
                    }
                };
                reader.readAsText(file);
            }

            function resetData() {
                if (confirm('Are you absolutely sure? This will delete all your progress permanently.')) {
                    localStorage.removeItem('lifeOSData');
                    location.reload();
                }
            }
            
            // --- MODAL ---
            const modal = document.getElementById('milestone-modal');
            const modalCloseBtn = document.getElementById('modal-close-btn');

            function showMilestoneModal(message) {
                document.getElementById('modal-message').textContent = `Congratulations on completing: ${message}! Keep up the great work.`;
                modal.style.display = 'flex';
            }

            modalCloseBtn.onclick = function() {
                modal.style.display = 'none';
            }
            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            }

            // --- LET'S GO ---
            init();
        });
    </script>
    <script>
        // Register the Service Worker for offline functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
    </script>
</body>
</html>
